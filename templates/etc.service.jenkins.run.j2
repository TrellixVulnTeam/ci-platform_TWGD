#!/bin/sh

echo 2.0 > /var/lib/jenkins/upgraded
echo 2.0 > /var/lib/jenkins/jenkins.install.UpgradeWizard.state
chown -R jenkins:jenkins /var/lib/jenkins
chmod 700 /var/lib/jenkins/.ssh
chmod 600 /var/lib/jenkins/.ssh/id_rsa

# https://issues.jenkins-ci.org/browse/JENKINS-31619
mkdir -p ~/jenkins/.jenkins/cache/jars
chown -R jenkins:jenkins ~/jenkins/.jenkins
export JENKINS_HOME=/var/lib/jenkins

# TODO: These are not in place yet, lets keep them here for mesos
# export LIBPROCESS_IP=external ip from env variable
# export LIBPROCESS_PORT=external port
# export libprocess_advertive_...

echo "starting... "
cd /
rm -f config.yml ; rm -rf target
curl $TEMPURL > config.yml && \
    python -u /render.py && \
    tar -C /target -cvzf /config/config.tar.gz . && \
    rm -rf /target && \
    rm -f config.yml && \
    echo "finished"

cd /var/lib/jenkins
exec /sbin/setuser jenkins /usr/bin/java {{ jenkins['jvm_args'] }} -Djava.awt.headless=true  -jar /usr/share/jenkins/jenkins.war --httpPort={{ jenkins['port'] }} 2>&1 | tee -a /var/log/jenkins/jenkins.log
